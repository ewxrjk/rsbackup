#! /usr/bin/make -f

INSTALL=install
PACKAGE=rsbackup
VERSION=0.2.DEV

build:
	[ -e configure ] || ./autogen.sh
	./configure --prefix=/usr --mandir=/usr/share/man
	$(MAKE)

clean-${PACKAGE}:
	rm -rf debian/${PACKAGE}

binary-${PACKAGE}:
	mkdir -p debian/${PACKAGE}/DEBIAN
	mkdir -p debian/${PACKAGE}/etc/rsbackup/hosts.d
	mkdir -p debian/${PACKAGE}/etc/cron.hourly
	mkdir -p debian/${PACKAGE}/etc/cron.daily
	mkdir -p debian/${PACKAGE}/etc/cron.weekly
	mkdir -p debian/${PACKAGE}/etc/cron.monthly
	mkdir -p debian/${PACKAGE}/usr/share/doc/${PACKAGE}
	cp debian/${PACKAGE}.conffiles debian/${PACKAGE}/DEBIAN/conffiles
	cp debian/${PACKAGE}.postinst debian/${PACKAGE}/DEBIAN/postinst
	cp tools/rsbackup.hourly debian/${PACKAGE}/etc/cron.hourly/rsbackup
	cp tools/rsbackup.daily debian/${PACKAGE}/etc/cron.daily/rsbackup
	cp tools/rsbackup.weekly debian/${PACKAGE}/etc/cron.weekly/rsbackup
	cp tools/rsbackup.monthly debian/${PACKAGE}/etc/cron.monthly/rsbackup
	cp tools/rsbackup.config debian/${PACKAGE}/etc/rsbackup/config
	cp tools/rsbackup.defaults debian/${PACKAGE}/etc/rsbackup/defaults
	cp tools/rsbackup.devices debian/${PACKAGE}/etc/rsbackup/devices
	cp debian/changelog debian/${PACKAGE}/usr/share/doc/${PACKAGE}/.
	cp README debian/${PACKAGE}/usr/share/doc/${PACKAGE}/.
	gzip -9v debian/${PACKAGE}/usr/share/doc/${PACKAGE}/*
	cp doc/debian.html debian/${PACKAGE}/usr/share/doc/${PACKAGE}/.
	cp doc/disk-encryption.html debian/${PACKAGE}/usr/share/doc/${PACKAGE}/.
	cp doc/rsbackup-manual.html debian/${PACKAGE}/usr/share/doc/${PACKAGE}/.
	cp debian/copyright debian/${PACKAGE}/usr/share/doc/${PACKAGE}/.
	$(MAKE) DESTDIR=`pwd`/debian/${PACKAGE} install
	gzip -9v debian/${PACKAGE}/usr/share/man/man*/*
	dh_perl -Pdebian/${PACKAGE} --package=${PACKAGE}
	cd debian/${PACKAGE} && \
	  find -name DEBIAN -prune -o -type f -print \
	    | sed 's/^\.\///' \
			| xargs md5sum > DEBIAN/md5sums
	dpkg-gencontrol -isp -p${PACKAGE} -Pdebian/${PACKAGE} \
		-Tdebian/substvars
	chown -R root:root debian/${PACKAGE}
	chmod -R g-ws debian/${PACKAGE}
	dpkg --build debian/${PACKAGE} ..

binary: binary-arch binary-indep
binary-arch:
binary-indep: binary-${PACKAGE}

clean: clean-${PACKAGE}
	rm -f debian/files
	rm -f debian/debhelper.log
	$(MAKE) distclean

distcheck:
	$(MAKE) dist
	gzip -cd rsbackup-${VERSION}.tar.gz | tar xf -
	debian/rules -C rsbackup-${VERSION} build
	fakeroot debian/rules -C rsbackup-${VERSION} binary
	rm -rf rsbackup-${VERSION}
	ls -l rsbackup_${VERSION}_all.deb rsbackup-${VERSION}.tar.gz
